var J=Object.defineProperty;var K=(r,e,n)=>e in r?J(r,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):r[e]=n;var k=(r,e,n)=>K(r,typeof e!="symbol"?e+"":e,n);const B=Math.sqrt(3),N=.5*(B-1),S=(3-B)/6,G=r=>Math.floor(r)|0,W=new Float64Array([1,1,-1,1,1,-1,-1,-1,1,0,-1,0,1,0,-1,0,0,1,0,-1,0,1,0,-1]);function O(r=Math.random){const e=Q(r),n=new Float64Array(e).map(o=>W[o%12*2]),t=new Float64Array(e).map(o=>W[o%12*2+1]);return function(s,a){let l=0,h=0,F=0;const b=(s+a)*N,u=G(s+b),R=G(a+b),D=(u+R)*S,_=u-D,Y=R-D,f=s-_,g=a-Y;let P,z;f>g?(P=1,z=0):(P=0,z=1);const v=f-P+S,C=g-z+S,I=f-1+2*S,$=g-1+2*S,T=u&255,A=R&255;let p=.5-f*f-g*g;if(p>=0){const d=T+e[A],y=n[d],X=t[d];p*=p,l=p*p*(y*f+X*g)}let w=.5-v*v-C*C;if(w>=0){const d=T+P+e[A+z],y=n[d],X=t[d];w*=w,h=w*w*(y*v+X*C)}let x=.5-I*I-$*$;if(x>=0){const d=T+1+e[A+1],y=n[d],X=t[d];x*=x,F=x*x*(y*I+X*$)}return 70*(l+h+F)}}function Q(r){const n=new Uint8Array(512);for(let t=0;t<512/2;t++)n[t]=t;for(let t=0;t<512/2-1;t++){const o=t+~~(r()*(256-t)),s=n[t];n[t]=n[o],n[o]=s}for(let t=256;t<512;t++)n[t]=n[t-256];return n}class j{constructor(e){k(this,"state");this.state=e>>>0}next(){let e=this.state+=1831565813;return e=(e^e>>>15)*(e|1),e^=e+(e^e>>>7)*(e|61),((e^e>>>14)>>>0)/4294967296}nextInt(e,n){return Math.floor(this.next()*(n-e+1))+e}nextFloat(e,n){return this.next()*(n-e)+e}}class U{constructor(e){k(this,"prng");this.prng=new j(e)}growString(e){let n=e.axiom;for(let t=0;t<e.iterations;t++){let o="";for(let s=0;s<n.length;s++){const a=n[s];let l=a;for(const h of e.rules)if(h.predecessor===a&&(h.probability===void 0||this.prng.next()<h.probability)){l=h.successor;break}o+=l}n=o}return n}generatePlantPreset(e,n=5){const t=new j(e),o=t.nextInt(0,3),s=Math.min(n,5),a={axiom:"X",rules:[],angle:25+t.nextFloat(-5,5),iterations:s,length:10-s,lengthReduction:.8+t.nextFloat(-.1,.1),branchWidthBase:5,branchWidthReduction:.7+t.nextFloat(-.1,.1),leafSize:5+t.nextFloat(-1,3),leafColor:`hsl(${100+t.nextInt(-20,20)}, ${60+t.nextInt(-20,10)}%, ${40+t.nextInt(-10,10)}%)`,stemColor:`hsl(${25+t.nextInt(-10,10)}, ${50+t.nextInt(-20,10)}%, ${30+t.nextInt(-10,10)}%)`};switch(o){case 0:a.rules=[{predecessor:"X",successor:"F+[[X]-X]-F[-FX]+X"},{predecessor:"F",successor:"FF"}],a.angle=22+t.nextFloat(-3,3);break;case 1:a.rules=[{predecessor:"X",successor:"F[+X][-X]FX"},{predecessor:"F",successor:"FF"}],a.angle=35+t.nextFloat(-5,5),a.leafSize*=1.2;break;case 2:a.rules=[{predecessor:"X",successor:"F[+X][-X][++X][--X]FX"},{predecessor:"F",successor:"FF"}],a.angle=30+t.nextFloat(-5,5);break;case 3:a.axiom="FX",a.rules=[{predecessor:"X",successor:"[-FX][+FX]"},{predecessor:"F",successor:"FF",probability:.8}],a.angle=40+t.nextFloat(-8,8);break}return a}}class H{constructor(){k(this,"memoizedPaths",new Map)}drawLSystem(e,n,t,o=0){const s=`${n}_${t.iterations}_${t.angle}`;if(!this.memoizedPaths.has(s)){const l=this.createPath(n,t);this.memoizedPaths.set(s,l)}const a=this.memoizedPaths.get(s);e.save(),e.translate(e.canvas.width/2,e.canvas.height),e.translate(o*20,0),e.strokeStyle=t.stemColor,e.fillStyle=t.leafColor,e.lineWidth=t.branchWidthBase,e.lineCap="round",e.lineJoin="round",e.stroke(a),e.restore()}createPath(e,n){const t=new Path2D,o=[];let s={x:0,y:0,angle:-90,length:n.length,width:n.branchWidthBase};t.moveTo(s.x,s.y);for(let a=0;a<e.length;a++)switch(e[a]){case"F":const h=s.angle*Math.PI/180,F=s.x+s.length*Math.cos(h),b=s.y+s.length*Math.sin(h);t.lineTo(F,b),s.x=F,s.y=b;break;case"+":s.angle+=n.angle;break;case"-":s.angle-=n.angle;break;case"[":o.push({...s}),s.length*=n.lengthReduction,s.width*=n.branchWidthReduction;break;case"]":if(o.length>0){const u=o.pop();t.moveTo(u.x,u.y),s=u}break}return t}clearMemoizedPaths(){this.memoizedPaths.clear()}}let i=null,c=null,L=[],M=!0,m=null;const Z=O(),V=new H,q=new U(Date.now());function ee(r){if(i=r,c=i.getContext("2d",{alpha:!1}),!c){console.error("Failed to get 2D context from OffscreenCanvas");return}E()}function te(r){L=r.map(e=>{const n=Math.min(5,e.ageInDays);return e.settings||(e.settings=q.generatePlantPreset(e.seed,n)),e})}function ne(r){M=r,M&&!m?E():!M&&m!==null&&(cancelAnimationFrame(m),m=null)}function se(r,e){i&&(i.width=r,i.height=e,V.clearMemoizedPaths())}function E(){performance.now();const r=e=>{M&&c&&i&&re(e),m=requestAnimationFrame(r)};m=requestAnimationFrame(r)}function re(r,e){if(!c||!i)return;c.clearRect(0,0,i.width,i.height);const n=c.createLinearGradient(0,0,0,i.height);n.addColorStop(0,"#87CEEB"),n.addColorStop(1,"#8FBC8F"),c.fillStyle=n,c.fillRect(0,0,i.width,i.height),L.forEach((t,o)=>{if(!t.settings||!i)return;const s=o%3*(i.width/3)+i.width/6,a=Z(t.seed/1e3,r/2e3)*.5;if(c.save(),!i||!c)return;c.translate(s,0);const l=q.growString(t.settings);V.drawLSystem(c,l,t.settings,a),c.restore()})}self.onmessage=r=>{const e=r.data;switch(e.type){case"init":ee(e.canvas);break;case"updatePlants":te(e.plants);break;case"setVisible":ne(e.isVisible);break;case"resize":se(e.width,e.height);break}};
