var Y=Object.defineProperty;var J=(r,e,n)=>e in r?Y(r,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):r[e]=n;var z=(r,e,n)=>J(r,typeof e!="symbol"?e+"":e,n);const B=Math.sqrt(3),K=.5*(B-1),S=(3-B)/6,G=r=>Math.floor(r)|0,W=new Float64Array([1,1,-1,1,1,-1,-1,-1,1,0,-1,0,1,0,-1,0,0,1,0,-1,0,1,0,-1]);function N(r=Math.random){const e=O(r),n=new Float64Array(e).map(a=>W[a%12*2]),t=new Float64Array(e).map(a=>W[a%12*2+1]);return function(s,o){let i=0,h=0,F=0;const b=(s+o)*K,d=G(s+b),v=G(o+b),D=(d+v)*S,E=d-D,_=v-D,f=s-E,g=o-_;let P,k;f>g?(P=1,k=0):(P=0,k=1);const C=f-P+S,I=g-k+S,R=f-1+2*S,$=g-1+2*S,T=d&255,A=v&255;let p=.5-f*f-g*g;if(p>=0){const u=T+e[A],y=n[u],X=t[u];p*=p,i=p*p*(y*f+X*g)}let w=.5-C*C-I*I;if(w>=0){const u=T+P+e[A+k],y=n[u],X=t[u];w*=w,h=w*w*(y*C+X*I)}let x=.5-R*R-$*$;if(x>=0){const u=T+1+e[A+1],y=n[u],X=t[u];x*=x,F=x*x*(y*R+X*$)}return 70*(i+h+F)}}function O(r){const n=new Uint8Array(512);for(let t=0;t<512/2;t++)n[t]=t;for(let t=0;t<512/2-1;t++){const a=t+~~(r()*(256-t)),s=n[t];n[t]=n[a],n[a]=s}for(let t=256;t<512;t++)n[t]=n[t-256];return n}class j{constructor(e){z(this,"state");this.state=e>>>0}next(){let e=this.state+=1831565813;return e=(e^e>>>15)*(e|1),e^=e+(e^e>>>7)*(e|61),((e^e>>>14)>>>0)/4294967296}nextInt(e,n){return Math.floor(this.next()*(n-e+1))+e}nextFloat(e,n){return this.next()*(n-e)+e}}class Q{constructor(e){z(this,"prng");this.prng=new j(e)}growString(e){let n=e.axiom;for(let t=0;t<e.iterations;t++){let a="";for(let s=0;s<n.length;s++){const o=n[s];let i=o;for(const h of e.rules)if(h.predecessor===o&&(h.probability===void 0||this.prng.next()<h.probability)){i=h.successor;break}a+=i}n=a}return n}generatePlantPreset(e,n=5){const t=new j(e),a=t.nextInt(0,3),s=Math.min(n,5),o={axiom:"X",rules:[],angle:25+t.nextFloat(-5,5),iterations:s,length:10-s,lengthReduction:.8+t.nextFloat(-.1,.1),branchWidthBase:5,branchWidthReduction:.7+t.nextFloat(-.1,.1),leafSize:5+t.nextFloat(-1,3),leafColor:`hsl(${100+t.nextInt(-20,20)}, ${60+t.nextInt(-20,10)}%, ${40+t.nextInt(-10,10)}%)`,stemColor:`hsl(${25+t.nextInt(-10,10)}, ${50+t.nextInt(-20,10)}%, ${30+t.nextInt(-10,10)}%)`};switch(a){case 0:o.rules=[{predecessor:"X",successor:"F+[[X]-X]-F[-FX]+X"},{predecessor:"F",successor:"FF"}],o.angle=22+t.nextFloat(-3,3);break;case 1:o.rules=[{predecessor:"X",successor:"F[+X][-X]FX"},{predecessor:"F",successor:"FF"}],o.angle=35+t.nextFloat(-5,5),o.leafSize*=1.2;break;case 2:o.rules=[{predecessor:"X",successor:"F[+X][-X][++X][--X]FX"},{predecessor:"F",successor:"FF"}],o.angle=30+t.nextFloat(-5,5);break;case 3:o.axiom="FX",o.rules=[{predecessor:"X",successor:"[-FX][+FX]"},{predecessor:"F",successor:"FF",probability:.8}],o.angle=40+t.nextFloat(-8,8);break}return o}}class U{constructor(){z(this,"memoizedPaths",new Map)}drawLSystem(e,n,t,a=0){const s=`${n}_${t.iterations}_${t.angle}`;if(!this.memoizedPaths.has(s)){const i=this.createPath(n,t);this.memoizedPaths.set(s,i)}const o=this.memoizedPaths.get(s);e.save(),e.translate(e.canvas.width/2,e.canvas.height),e.translate(a*20,0),e.strokeStyle=t.stemColor,e.fillStyle=t.leafColor,e.lineWidth=t.branchWidthBase,e.lineCap="round",e.lineJoin="round",e.stroke(o),e.restore()}createPath(e,n){const t=new Path2D,a=[];let s={x:0,y:0,angle:-90,length:n.length,width:n.branchWidthBase};t.moveTo(s.x,s.y);for(let o=0;o<e.length;o++)switch(e[o]){case"F":const h=s.angle*Math.PI/180,F=s.x+s.length*Math.cos(h),b=s.y+s.length*Math.sin(h);t.lineTo(F,b),s.x=F,s.y=b;break;case"+":s.angle+=n.angle;break;case"-":s.angle-=n.angle;break;case"[":a.push({...s}),s.length*=n.lengthReduction,s.width*=n.branchWidthReduction;break;case"]":if(a.length>0){const d=a.pop();t.moveTo(d.x,d.y),s=d}break}return t}clearMemoizedPaths(){this.memoizedPaths.clear()}}let c=null,l=null,L=[],M=!0,m=null;const H=N(),Z=new U,V=new Q(Date.now());function ee(r){if(c=r,l=c.getContext("2d"),!l){console.error("Failed to get 2D context from OffscreenCanvas");return}q()}function te(r){L=r.map(e=>{const n=Math.min(5,e.ageInDays);return e.settings||(e.settings=V.generatePlantPreset(e.seed,n)),e})}function ne(r){M=r,M&&!m?q():!M&&m!==null&&(cancelAnimationFrame(m),m=null)}function q(){performance.now();const r=e=>{M&&l&&c&&se(e),m=requestAnimationFrame(r)};m=requestAnimationFrame(r)}function se(r,e){if(!l||!c)return;l.clearRect(0,0,c.width,c.height);const n=l.createLinearGradient(0,0,0,c.height);n.addColorStop(0,"#87CEEB"),n.addColorStop(1,"#8FBC8F"),l.fillStyle=n,l.fillRect(0,0,c.width,c.height),L.forEach((t,a)=>{if(!t.settings||!c)return;const s=a%3*(c.width/3)+c.width/6,o=H(t.seed/1e3,r/2e3)*.5;if(l.save(),!c||!l)return;l.translate(s,0);const i=V.growString(t.settings);Z.drawLSystem(l,i,t.settings,o),l.restore()})}self.onmessage=r=>{const e=r.data;switch(e.type){case"init":ee(e.canvas);break;case"updatePlants":te(e.plants);break;case"setVisible":ne(e.isVisible);break}};
